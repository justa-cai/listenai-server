# VoxCPM WebSocket TTS Server - 需求文档

## 1. 项目概述

### 1.1 项目名称

VoxCPM WebSocket TTS Server

### 1.2 项目背景

VoxCPM 是 ModelBest 推出的一款端到端 TTS（Text-to-Speech）模型，能够生成高质量且富有表现力的语音。本项目旨在基于 VoxCPM-0.5B 模型构建一个 WebSocket 服务器，提供实时流式和非流式语音合成服务。

### 1.3 项目目标

- 提供基于 WebSocket 的实时 TTS 服务
- 支持流式和非流式两种语音合成模式
- 支持声音克隆（通过参考音频）
- 提供简单易用的 API 接口
- 支持高并发和低延迟

## 2. 功能需求

### 2.1 核心功能

#### FR-001: 文本转语音

**优先级:** P0 (必须有)

**描述:** 服务器必须能够将输入的文本转换为语音音频。

**验收标准:**
- 支持中文文本输入
- 支持英文文本输入
- 支持中英混合文本输入
- 生成的音频质量清晰自然
- 支持自定义发音（通过参考音频）

#### FR-002: 流式输出

**优先级:** P0 (必须有)

**描述:** 服务器必须支持流式音频输出，实时返回生成的音频片段。

**验收标准:**
- 音频片段按生成顺序返回
- 音频片段可以连续播放
- 首个音频片段延迟 < 1 秒
- 支持边生成边播放

#### FR-003: 非流式输出

**优先级:** P0 (必须有)

**描述:** 服务器必须支持非流式模式，一次性返回完整的音频数据。

**验收标准:**
- 返回完整的音频数据
- 支持大文本输入
- 提供进度反馈

#### FR-004: 声音克隆

**优先级:** P1 (应该有)

**描述:** 服务器应该支持通过参考音频进行声音克隆。

**验收标准:**
- 支持上传参考音频
- 生成的语音与参考声音相似
- 支持参考文本（可选）

#### FR-005: 请求取消

**优先级:** P1 (应该有)

**描述:** 服务器应该支持取消正在进行的 TTS 请求。

**验收标准:**
- 可以取消正在排队中的请求
- 可以取消正在处理中的请求
- 取消后及时释放资源

#### FR-006: 进度反馈

**优先级:** P1 (应该有)

**描述:** 服务器应该提供 TTS 请求的处理进度信息。

**验收标准:**
- 实时返回处理状态
- 提供进度百分比
- 包含状态描述信息

### 2.2 高级功能

#### FR-007: 参数可配置

**优先级:** P1 (应该有)

**描述:** 服务器应该支持通过参数调整 TTS 生成效果。

**验收标准:**
- 支持 cfg_value 参数（生成质量 vs 速度）
- 支持 inference_timesteps 参数（推理步数）
- 支持文本规范化开关
- 支持降噪开关
- 支持坏案例重试配置

#### FR-008: 心跳保活

**优先级:** P2 (可以有)

**描述:** 服务器应该支持心跳机制，保持长连接活跃。

**验收标准:**
- 支持 ping/pong 消息
- 自动检测并清理死连接
- 可配置心跳间隔

#### FR-009: 错误处理

**优先级:** P0 (必须有)

**描述:** 服务器必须能够正确处理各种错误情况。

**验收标准:**
- 参数错误时返回明确的错误信息
- 模型加载失败时返回错误
- 生成失败时返回错误原因
- 不因单个请求错误而崩溃

### 2.3 非功能需求

#### NFR-001: 性能

**优先级:** P0 (必须有)

**描述:** 服务器必须满足一定的性能指标。

**指标:**
- 首个音频片段延迟 < 1 秒
- 流式模式下的生成速度 > 实时播放速度
- 单个 WebSocket 连接的处理延迟 < 100ms

#### NFR-002: 并发

**优先级:** P0 (必须有)

**描述:** 服务器必须支持多个并发连接。

**指标:**
- 支持 10 个并发 TTS 请求
- 支持 100 个并发 WebSocket 连接
- 请求队列容量可配置

#### NFR-003: 可靠性

**优先级:** P1 (应该有)

**描述:** 服务器应该稳定可靠。

**指标:**
- 7x24 小时稳定运行
- 异常情况下自动恢复
- 资源泄漏检测

#### NFR-004: 可扩展性

**优先级:** P2 (可以有)

**描述:** 服务器架构应该支持水平扩展。

**指标:**
- 支持多实例部署
- 支持负载均衡
- 支持配置热更新

## 3. 用户故事

### US-001: 实时语音助手

**作为** 一个语音助手的开发者

**我想要** 通过 WebSocket 实时获取 TTS 音频

**以便** 实现低延迟的语音对话体验

**验收标准:**
- 连接服务器后发送文本
- 在 1 秒内收到首个音频片段
- 音频片段可以边收边播

### US-002: 音频内容制作

**作为** 一个内容创作者

**我想要** 批量生成高质量的语音文件

**以便** 快速制作有声读物或播客

**验收标准:**
- 支持长文本输入
- 生成高保真音频
- 可以保存为文件

### US-003: 个性化语音定制

**作为** 一个应用开发者

**我想要** 使用特定声音生成 TTS

**以便** 为我的应用提供独特的语音体验

**验收标准:**
- 上传参考音频
- 生成的语音与参考声音相似
- 可以保存和使用自定义声音

### US-004: 实时对话系统

**作为** 一个对话系统的开发者

**我想要** 能够取消正在生成的 TTS

**以便** 及时响应用户的新输入

**验收标准:**
- 发送取消请求
- 当前生成立即停止
- 资源被正确释放

## 4. 界面需求

### 4.1 API 界面

- WebSocket 连接端点
- JSON 格式的控制消息
- 二进制格式的音频数据

### 4.2 管理界面 (可选)

- 连接状态监控
- 请求队列查看
- 性能指标展示

## 5. 约束条件

### 5.1 技术约束

- 使用 VoxCPM-0.5B 模型
- 使用 Python 实现服务器
- 使用 WebSocket 协议
- 音频格式为 PCM 16-bit

### 5.2 资源约束

- 模型加载内存占用约 2GB
- GPU 内存占用约 4GB（如果使用 GPU）
- 每个 TTS 请求额外内存约 500MB

### 5.3 时间约束

- 项目开发周期：2 周
- MVP 交付时间：1 周

## 6. 依赖项

### 6.1 外部依赖

| 依赖项 | 版本 | 用途 |
|--------|------|------|
| voxcpm | latest | TTS 模型 |
| torch | >=2.0 | 深度学习框架 |
| soundfile | >=0.12 | 音频文件读写 |
| websockets | >=12.0 | WebSocket 服务 |
| numpy | >=1.24 | 数值计算 |

### 6.2 系统依赖

- Python 3.10+
- CUDA 11.8+ (可选，用于 GPU 加速)
- 至少 8GB 内存
- 至少 10GB 磁盘空间

## 7. 风险评估

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 模型加载失败 | 高 | 低 | 预加载模型，健康检查 |
| 内存溢出 | 高 | 中 | 限制并发数，请求队列 |
| 音频质量不佳 | 中 | 低 | 参数调优，重试机制 |
| 网络延迟 | 中 | 中 | 流式输出，本地缓存 |

## 8. 里程碑

| 里程碑 | 交付物 | 时间 |
|--------|--------|------|
| M1: 基础功能 | 非/流式 TTS 基本功能 | Week 1 |
| M2: 完整功能 | 所有核心功能实现 | Week 1.5 |
| M3: 优化稳定 | 性能优化和稳定性 | Week 2 |

## 9. 验收标准

### 9.1 功能验收

- [ ] 可以成功连接 WebSocket 服务器
- [ ] 非流式模式正确返回音频
- [ ] 流式模式正确返回音频片段
- [ ] 声音克隆功能正常工作
- [ ] 请求可以被正确取消
- [ ] 错误情况被正确处理

### 9.2 性能验收

- [ ] 首个音频片段延迟 < 1 秒
- [ ] 支持 10 个并发 TTS 请求
- [ ] 服务器内存稳定，无泄漏

### 9.3 文档验收

- [ ] 协议文档完整
- [ ] API 文档清晰
- [ ] 客户端示例可用

## 10. 附录

### 10.1 术语表

| 术语 | 定义 |
|------|------|
| TTS | Text-to-Speech，文本转语音 |
| 流式 | 边生成边发送，实时返回 |
| 非流式 | 全部生成后一次性返回 |
| 声音克隆 | 使用参考音频复制特定说话人的声音 |

### 10.2 参考资料

- [VoxCPM GitHub](https://github.com/OpenBMB/VoxCPM)
- [VoxCPM 论文](https://arxiv.org/abs/xxxx.xxxxx)
- WebSocket Protocol RFC 6455
